/**
 * sonnyJS v0.1.6
 * www.github.com/felixmaier/sonnyJS
 * @author Felix Maier
 */
(function(){var h=function(a){return document.querySelector(a)},b=b||{};b.VERSION="0.1.6";b.PAGEPATH="view/";b.CONFIGPATH="./config.json";b.FILETYPE=".html";b.STORAGE_EXT="SY::";b.HISTORY=window.history&&"object"===typeof window.onpopstate?!0:!1;b.LOCALSTORAGE="undefined"!==typeof Storage||void 0!==window.localStorage?!0:!1;b.ORIGINALHISTORY=window.location.href;b.INITIALIZED=0;b.SHOWVERSION=!1;b.CONST={APP:"APP",LOAD:"syload",INCLUDE:"include",VAR:"var"};b.Virtualiser=function(a){var c=this;if(b.LOADED){var d=
{},e;for(e in c.PLAINPAGES)if(c.PLAINPAGES[e]instanceof HTMLElement){var f=c.compiler.HTML(c.PLAINPAGES[e]);f.content=f.inside;f.path=e;delete f.inside;d[e]=new b.Page(f)}c.PAGES=d;c.PAGES=c.interpreter.Includes(c.PAGES);c.PAGES=c.interpreter.Variables(c.PAGES)}else this.init(this.VIRTUALPAGES,function(d){c.PAGES=d;c.PAGES=c.interpreter.Includes(d);c.PAGES=c.interpreter.Variables(d);b.LOADED=!0;a();c.STARTPAGE?c.renderer.render(c.STARTPAGE):c.history&&c.history.additionalURL.length&&c.CURRENTPAGE!==
c.history.additionalURL&&c.renderer.render(c.history.additionalURL+b.FILETYPE)})};b.Virtualiser.prototype.constructor=b.Virtualiser;b.Virtualiser.prototype.init=function(a,c){var d=this,e={};if("object"===typeof a){var f=[];Object.keys(a).forEach(function(b){f.push(a[b])});f.length&&(a=f)}var g=function(a){"string"===typeof a[0]&&b.AJAX(b.PAGEPATH+a[0],function(f){if(e[a[0]])throw Error("Multiple definition of "+e[a[0]].path+"!");var k=d.compiler;f=k.DOM(f);if(f.tagName!==b.CONST.APP)throw Error('Missing "app" tag in '+
a[0]+"!");k=k.HTML(f);k.content=k.inside;k.path=a[0];delete k.inside;d.PLAINPAGES[a[0]]=f;e[a.shift()]=new b.Page(k);a.length?g(a):c(e)})};g(a)};b.Page=function(a){this.name=String(a.sitename);this.path=String(a.path);this.requireServer=Boolean(a.requireserver)||!1;this.content=a.content;this.global=Boolean(a.global)||!1;this.renderedTimes=this.includes=0;this.ready=!0};b.Page.prototype.constructor=b.Page;b.Interpreter=function(a){a&&(this.__instance=a)};b.Interpreter.prototype.constructor=b.Interpreter;
b.Interpreter.prototype.Includes=function(a){var c=this,d=a,e=function(a){for(var b in a)"object"===typeof a[b]&&(e(a[b]),a.content&&(d=a,a.content=f(a.content)));return a},f=function(a){for(var e in a)if("object"===typeof a[e]&&(a[e]=f(a[e]),a[e].key&&a[e].key===b.CONST.INCLUDE)){d.includes++;var l=f(c.__instance.renderer.get(a[e].page+b.FILETYPE)).content;a.splice(e,!0);a.splice.apply(f(a),[e,0].concat(l))}return a};return e(d)};b.Interpreter.prototype.Variables=function(a){var c=a,d=this.__instance.VARIABLES,
e=this.__instance.LANGUAGE,f=function(a){for(var b in a)"object"===typeof a[b]&&(f(a[b]),a.content&&(c=a,a.content=g(a.content)));return a},g=function(a){for(var c in a)if("object"===typeof a[c]&&(a[c]=g(a[c]),a[c].key&&a[c].key===b.CONST.VAR))if(a[c].variable){var f=a[c].variable;a[c]={};a[c].text=d[f]?d[f]||"undefined":e&&d[e]&&d[e][f]?d[e][f]:"undefined"}else a[c].text="undefined";return a};return f(c)};b.Compiler=function(a){a&&(this.__instance=a)};b.Compiler.prototype.constructor=b.Compiler;
b.Compiler.prototype.DOM=function(a){var b=document.implementation.createHTMLDocument("html");b.documentElement.innerHTML=a;return b.body.children[0]};b.Compiler.prototype.HTML=function(a){if(!a instanceof Object)throw Error("Received arguments of invalid type");var c={};c.key=a.tagName.toLowerCase();if(a.hasAttribute)if(c.key===b.CONST.INCLUDE)for(var d=0;d<a.attributes.length;++d){if("page"===a.attributes[d].nodeName||"page"===a.attributes[d].localName)c.page=a.attributes[d].value||a.attributes[d].value}else if("var"===
c.key)for(var d=0,e="";d<a.attributes.length;)e+=(0<d?"_":"")+a.attributes[d].name,++d===a.attributes.length&&(e=e.replace(/%/gi,""),c.variable=e.toUpperCase());else for(d=0;d<a.attributes.length;d++)c[a.attributes[d].name]=a.attributes[d].value;if(a.hasChildNodes()){a=a.firstChild;3===a.nodeType&&""!==a.data.trim()&&(c.text=a.data);if(3===a.nodeType&&a.nextSibling||1===a.nodeType)c.inside=[];for(;a;)1===a.nodeType&&c.inside.push(this.HTML(a)),a=a.nextSibling}return c};b.Compiler.prototype.JSON=function(a,
c){var d,e=[];if(a.key!==b.CONST.INCLUDE&&a.key!==b.CONST.VAR){for(var f in a)if("key"===f)d=document.createElement(a.key);else if(d&&"text"===f)d.innerHTML=a.text;else if(d||"text"!==f||(d=document.createTextNode(a[f])),"inside"===f){if(a.inside)for(f=0;f<a.inside.length;++f){var g=this.JSON(a.inside[f]),h;for(h in g)d.appendChild(g[h])}}else try{d&&"backup"!==f&&"#text"!==d.nodeName&&d.setAttribute(f,a[f])}catch(l){throw Error("JSON rendering failed: "+l);}d=(new b.Vivifier(this.__instance)).vivify(d);
e.push(d)}return e};b.Vivifier=function(a){this.instance=a||this};b.Vivifier.prototype.constructor=b.Vivifier;b.Vivifier.prototype.vivify=function(a){var c=this;if(!a)throw Error("Invalid element type!");if(a.nodeName&&"#text"===a.nodeName)return a;a.attributes[b.CONST.LOAD]&&(a.attributes[b.CONST.LOAD].value.match(":")?a=this.addListeners(a,b.CONST.LOAD):a.addEventListener("click",function(){c.instance.render(a.attributes[b.CONST.LOAD].value+b.FILETYPE)}));return a};b.Vivifier.prototype.addListeners=
function(a,c){var d=this,e=a.attributes[c].value.split(":");if(2<=e[0].split("&").length)for(var e=e[0].match("&")?e[0].split("&"):e,f=0;f<e.length;f++)e[f].trim(),a.addEventListener(e[f],function(){d.instance.render(a.attributes[c].value.split(":")[1]+b.FILETYPE)});else a.addEventListener(e[0],function(){d.instance.render(e[1]+b.FILETYPE)});return a};b.Renderer=function(a){a&&(this.__instance=a)};b.Renderer.prototype.constructor=b.Renderer;b.Renderer.prototype.render=function(a,c){a.match(b.FILETYPE)&&
(a=a.split(b.FILETYPE)[0]);if(!a instanceof String)throw Error("Invalid page format!");this.page=this.get(a+b.FILETYPE);this.page.global||(this.__instance.CURRENTPAGE=a);this.page.rendered=this.compile(this.page);this.compile(this.page);this.attach(this.page);!b.HISTORY||c||this.page.global||this.__instance.history.update(this.__instance.CURRENTPAGE)};b.Renderer.prototype.kill=function(a){if(a)switch(a){case "local":this.__instance.CONTAINERS.BODY.innerHTML="";break;case "global":this.__instance.CONTAINERS.GLOBALBODY.innerHTML=
""}else this.__instance.CONTAINERS.BODY&&(this.__instance.CONTAINERS.BODY.innerHTML="")};b.Renderer.prototype.compile=function(a){var c=new b.Compiler(this),d=[];a=a.content||a;for(var e in a)d.push(c.JSON(a[e]));this.page.global||this.kill();return d};b.Renderer.prototype.attach=function(a){var b=this,d=function(a,d){if(a.rendered)for(var g in a.rendered)for(var h in a.rendered[g])b.__instance.CONTAINERS[d].appendChild(a.rendered[g][h])};a.global?d(a,"GLOBALBODY"):d(a,"BODY")};b.Renderer.prototype.get=
function(a){if(this.__instance.PAGES[a])a=this.__instance.PAGES[a];else throw Error("The page "+a+" does not exist or was not successfully loaded!");return a};b.Notifications=function(a){a&&(this.__instance=a);"Notification"in window&&(this.notifySupport=!0,this.notification=null,this.permission=Notification.permission)};b.Notifications.prototype.constructor=b.Notifications;b.Notifications.prototype.show=function(a){this.notifySupport&&this.__instance.DISPLAYNOTIFICATIONS&&("granted"===this.permission?
"object"===typeof a&&(this.notification=new Notification(a.title,{tag:a.tag?a.tag:null,body:a.message?a.message:null,iconUrl:a.iconUrl?a.iconUrl:null,icon:a.icon?a.icon:null})):"denied"!==this.permission&&this.getPermission(a))};b.Notifications.prototype.getPermission=function(a){var b=this;Notification.requestPermission(function(d){"granted"===d&&b.show(a)})};b.Connection=function(a){if(!window.io)throw Error("SonnyJS requires Socket.IO!");if(a)this.__instance=a;else throw Error("SONNY.Connection requires an instance parameter!");
this.connected=!1;this.socket=io(window.location.host+":"+this.__instance.CONNECTIONPORT);this.connected=!0;this.__instance.ONLINE=!0;this.notifications=this.__instance.notify;this.init()};b.Connection.prototype.constructor=b.Connection;b.Connection.prototype.init=function(){var a=this;this.socket.on("connect",function(){a.notifications.show({title:"SONNY.Connection",message:"Connection established!",icon:"http://sonnyjs.org/favicon-96x96.png"})});this.socket.on("disconnect",function(){a.socket.disconnect();
a.notifications.show({title:"SONNY.Connection",message:"Connection closed!",icon:"http://sonnyjs.org/favicon-96x96.png"})})};b.HistoryManager=function(a){a&&(this.__instance=a);b.HISTORY&&(this.additionalURL=this.originalURL="",this.init())};b.HistoryManager.prototype.constructor=b.HistoryManager;b.HistoryManager.prototype.init=function(){var a=this,c=this.originalURL=b.ORIGINALHISTORY;RegExp("\\?","g").test(c)&&(c=c.split("?"),c[0]!==b.ORIGINALHISTORY&&(b.ORIGINALHISTORY=c[0],this.originalURL=b.ORIGINALHISTORY),
c.length&&(this.additionalURL=c[1]));window.onpopstate=function(b){b.state&&null!==b.state&&a.__instance.renderer.render(b.state,[])}};b.HistoryManager.prototype.update=function(a){history.pushState(a,a,this.originalURL+"?"+a)};b.StorageManager=function(a){if(a)this.__instance=a;else throw Error("SONNY.StorageManager requires an instance parameter!");b.LOCALSTORAGE&&(this.Storage=this.StorageName=null,this.activeWindows=1,this.__instance.GLOBALKEYS={},this.EmptyStorageTemplate={initialized:!0},this.init())};
b.StorageManager.prototype.constructor=b.StorageManager;b.StorageManager.prototype.init=function(){var a=this;this.synchonize();this.StorageName=b.STORAGE_EXT+"Instance::"+(new Date).getTime();localStorage[this.StorageName]||localStorage.setItem(this.StorageName,JSON.stringify(this.EmptyStorageTemplate));this.Storage=JSON.parse(localStorage[this.StorageName]);for(var c in localStorage)c.match(b.STORAGE_EXT+"Instance::")&&c!==a.StorageName&&localStorage.removeItem(c);window.addEventListener("beforeunload",
function(){localStorage.removeItem(a.StorageName)});window.addEventListener("storage",function(b){a.countWindows();localStorage[a.StorageName]||localStorage.setItem(a.StorageName,JSON.stringify(a.Storage));a.synchonize()})};b.StorageManager.prototype.onupdate=function(a){var c={};window.addEventListener("storage",function(){for(var d in localStorage)d.match(b.STORAGE_EXT)&&!d.match(b.STORAGE_EXT+"Instance")&&(c[d.split("::")[1]]=localStorage[d],a(c))})};b.StorageManager.prototype.keyExists=function(a){return this.__instance.GLOBALKEYS[a]||
localStorage[b.STORAGE_EXT+a]?!0:!1};b.StorageManager.prototype.createKey=function(a){this.keyExists(a.name)||(this.__instance.GLOBALKEYS[a.name]=a.data,localStorage.setItem(b.STORAGE_EXT+a.name,a.data))};b.StorageManager.prototype.deleteKey=function(a){delete this.__instance.GLOBALKEYS[a.name];localStorage.removeItem(b.STORAGE_EXT+a.name)};b.StorageManager.prototype.updateKey=function(a){this.keyExists(a.name)&&(this.__instance.GLOBALKEYS[a.name]=a.data,localStorage.setItem(b.STORAGE_EXT+a.name,
a.data))};b.StorageManager.prototype.synchonize=function(){var a={},c;for(c in localStorage)c.match(b.STORAGE_EXT)&&!c.match(b.STORAGE_EXT+"Instance")&&(a[c.split("::")[1]]=localStorage[c],this.__instance.GLOBALKEYS[c.split("::")[1]]?this.__instance.GLOBALKEYS[c.split("::")[1]]=localStorage[c]:this.__instance.GLOBALKEYS[c.split("::")[1]]||(this.__instance.GLOBALKEYS[c.split("::")[1]]=localStorage[c]));return a};b.StorageManager.prototype.countWindows=function(){this.activeWindows=0;for(var a in localStorage)a.match(b.STORAGE_EXT+
"Instance::")&&this.activeWindows++;return this.activeWindows};b.Instance=function(a){if(1<++b.INITIALIZED)throw Error("Cannot run multiple sonny instances!");var c=this;this.Greet();this.INSTANCE=this;this.CONTAINERS={BODYCONTAINER:"syContainer",GLOBALCONTAINER:"syGlobal"};this.CONTAINERS.BODY=h(this.CONTAINERS.BODYCONTAINER)||null;this.CONTAINERS.GLOBALBODY=h(this.CONTAINERS.GLOBALCONTAINER)||null;this.CURRENTPAGE=this.STARTPAGE=null;this.WIDTH=window.innerWidth;this.HEIGHT=window.innerHeight;this.CONNECTION=
this.ONLINE=this.FULLSCREEN=!1;this.CONNECTIONPORT=9005;this.DISPLAYNOTIFICATIONS=!0;this.VIRTUALPAGES=[];this.PAGES={};this.PLAINPAGES={};this.VARIABLES={};this.LANGUAGE=null;this.processConfiguration(function(){c.isMobile();c.resize();c.renderer=new b.Renderer(c);c.interpreter=new b.Interpreter(c);c.compiler=new b.Compiler(c);c.notify=new b.Notifications(c);c.history=new b.HistoryManager(c);c.createContainer(function(){b.Virtualiser.call(c,function(){c.CONNECTION?c.CONNECTION=new b.Connection(c):
null;a()})})})};b.Instance.prototype=Object.create(b.Virtualiser.prototype);b.Instance.prototype.constructor=b.Instance;b.Instance.prototype.createContainer=function(a){if(!this.CONTAINERS.BODY&&!this.CONTAINERS.BODY){var b=document.createElement(this.CONTAINERS.BODYCONTAINER),d=document.createElement(this.CONTAINERS.GLOBALCONTAINER);this.CONTAINERS.BODY=h("body");this.CONTAINERS.BODY.appendChild(d);this.CONTAINERS.BODY.appendChild(b);this.CONTAINERS.BODY=h(b.tagName.toLowerCase());this.CONTAINERS.GLOBALBODY=
h(d.tagName.toLowerCase())}a()};b.Instance.prototype.processConfiguration=function(a){var c=this;b.AJAX(b.CONFIGPATH,function(b){b=JSON.parse(b);if(b.Pages){if(!b.Settings instanceof Object)throw Error("Invalid Page definition");c.VIRTUALPAGES=b.Pages;delete b.Pages}if(b.Settings){if(!b.Settings instanceof Object)throw Error("Invalid settings type");for(var e in b.Settings){if(null===b.Settings[e]||void 0===b.Settings[e])throw Error(e+" value is invalid");var f=e;e=String(e.toUpperCase());if(void 0!==
c[e]||null===c[e])c[e]=b.Settings[f]}delete b.Settings}if(b.Variables){if(!b.Variables instanceof Object)throw Error("Invalid variable type");for(e in b.Variables)c.VARIABLES[e]||(c.VARIABLES[e]=b.Variables[e]);delete b.Variables}a()})};b.Instance.prototype.rebuild=function(){b.Virtualiser.call(this)};b.Instance.prototype.Greet=function(){-1<navigator.userAgent.toLowerCase().indexOf("chrome")?console.log.apply(console,["%c sonny.js "+b.VERSION+" ->%c http://www.sonnyjs.org/ ","color: #d9d9d9; background: #000",
"background: #000"]):window.console&&console.info("sonny.js "+b.VERSION+" -> http://www.sonnyjs.org/")};b.Instance.prototype.isMobile=function(){navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)?this.MOBILE=!0:this.MOBILE=!1};b.Instance.prototype.resize=function(){var a=this;window.addEventListener("resize",
function(){a.WIDTH=window.innerWidth;a.HEIGHT=window.innerHeight})};b.Instance.prototype.toggleFullscreen=function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),this.FULLSCREEN=!1):(document.documentElement.requestFullscreen?
document.documentElement.requestFullscreen():document.documentElement.msRequestFullscreen?document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),this.FULLSCREEN=!0);return this.FULLSCREEN};b.GET=function(){var a=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Microsoft.XMLHTTP"];if(window.ActiveXObject)for(;0<
a.length;)try{return new window.ActiveXObject(a[0])}catch(b){throw Error(b);}else return window.XMLHttpRequest?new window.XMLHttpRequest:!1};b.AJAX=function(a,c){var d=new b.GET;d.onload=function(){if(200===this.status)c(this.responseText);else throw Error("Status code was "+this.status);};d.open("GET",a+"?"+(new Date).getTime(),!0);d.send(null)};if(window.SONNY)throw Error("SonnyJS was already declared in this scope!");this.SONNY=b}).call(this);